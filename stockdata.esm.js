const t=require("lodash"),a=require("os"),e=require("path"),i=require("fs"),n=i.promises,r=require("pino")({level:process.env.LOGGER||"info",prettyPrint:{levelFirst:!0,translateTime:"SYS:yyyy-mm-dd HH:MM:ss.l",crlf:!0},prettifier:require("pino-pretty")}),o={daily:"daily",info:"info",financial:"fin"};function l(){return e.join(a.homedir(),".wtda")}async function c(){let a=null;try{await y();let i=e.join(l(),"stock-list.json");a=JSON.parse(await n.readFile(i,"utf-8")),t.isEmpty(a)||r.debug("股票列表更新时间 @"+a.updateTime)}catch(t){throw r.error("读取股票列表数据错误："+t),new Error("读取股票列表过程中出现错误，请检查后重新运行："+t)}return t.isEmpty(a)?{updateTime:"",data:[]}:a}async function s(){let a=null;try{await y();let i=e.join(l(),"index-list.json");a=JSON.parse(await n.readFile(i,"utf-8")),t.isEmpty(a)||r.debug("指数列表更新时间 @"+a.updateTime)}catch(t){throw r.error("读取指数列表数据错误："+t),new Error("读取指数列表过程中出现错误，请检查后重新运行："+t)}return t.isEmpty(a)?{updateTime:"",data:[]}:a}const d={daily:"daily",adjustFactor:"adjustFactor",suspendInfo:"suspendInfo",dailyBasic:"dailyBasic",moneyFlow:"moneyFlow",indexDaily:"indexDaily",income:"income",balanceSheet:"balanceSheet",cashFlow:"cashFlow",forecast:"forecast",express:"express",dividend:"dividend",financialIndicator:"financialIndicator",financialMainbiz:"financialMainbiz",disclosureDate:"disclosureDate",pledgeStat:"pledgeStat",pledgeDetail:"pledgeDetail"},f={daily:{name:"daily",path:o.daily,ext:""},adjustFactor:{name:"adjustFactor",path:o.daily,ext:".adj"},suspendInfo:{name:"suspendInfo",path:o.info,ext:".sus"},dailyBasic:{name:"dailyBasic",path:o.info,ext:".bsc"},moneyFlow:{name:"moneyFlow",path:o.info,ext:".mf"},indexDaily:{name:"indexDaily",path:o.daily,ext:""},income:{name:"income",path:o.financial,ext:".ic"},balanceSheet:{name:"balanceSheet",path:o.financial,ext:".bs"},cashFlow:{name:"cashFlow",path:o.financial,ext:".cf"},forecast:{name:"forecast",path:o.financial,ext:".fc"},express:{name:"express",path:o.financial,ext:".ep"},dividend:{name:"dividend",path:o.financial,ext:".dd"},financialIndicator:{name:"financialIndicator",path:o.financial,ext:".id"},financialMainbiz:{name:"financialMainbiz",path:o.financial,ext:".mb"},disclosureDate:{name:"disclosureDate",path:o.financial,ext:".dt"},pledgeStat:{name:"pledgeStat",path:o.financial,ext:".ps"},pledgeDetail:{name:"pledgeDetail",path:o.financial,ext:".pd"}};async function h(a,e){if(!d[a])throw new Error("不支持的数据类型："+a);if(t.isEmpty(e))throw new Error("未设置读取股票代码");let i={updateTime:null,data:[]},o=f[a];try{await y();let t=u(a,e);r.debug(`读取本地数据 ${e}.${a}，参数配置 %o，文件 ${t}`,o);try{i=JSON.parse(await n.readFile(t,"utf-8"))}catch(t){r.debug("读取文件时发生错误："+t),i={data:[]}}}catch(t){r.error(`从本地读取个股数据${a}时发生错误 ${t}`)}return i}function u(a,i){let n=f[a];if(!n)throw new Error("不支持的数据类型"+a);if(t.isEmpty(i))throw new Error("未设置读取股票代码");return e.join(l(),n.path,i+n.ext+".json")}async function y(){let t=l();try{await n.access(t,i.constants.F_OK|i.constants.R_OK|i.constants.W_OK)}catch(a){r.debug("检查数据根目录错误 "+a),await n.mkdir(t,{recursive:!0})}for(let a of Object.keys(o)){let l=e.join(t,o[a]);try{await n.access(l,i.constants.F_OK|i.constants.R_OK|i.constants.W_OK)}catch(t){r.debug(`检查目录${o[a]}错误 ${t}`),await n.mkdir(l,{recursive:!0})}}}y();const w=require("lodash"),p=require("moment"),g=require("@wt/lib-taskqueue"),m=require("@wt/lib-tushare"),$=require("pino")({level:process.env.LOGGER||"info",prettyPrint:{levelFirst:!0,translateTime:"SYS:yyyy-mm-dd HH:MM:ss.l",crlf:!0},prettifier:require("pino-pretty")}),b=require("path"),x=require("fs"),S=x.promises,F={[d.dividend]:d.dividend,[d.pledgeStat]:d.pledgeStat,[d.pledgeDetail]:d.pledgeDetail};async function D(t,a,e=!1){if(F[t])return I(a);if(w.isEmpty(t)||!d[t])throw Error("请填写正确的个股数据名称！"+t);if(w.isEmpty(a))throw Error("请填写正确的股票代码！"+a);let i;try{if(e){$.debug("需要强制更新数据："+a);try{let[e,n,r]=await m.queryStockInfo(t,a);i={updateTime:p().toISOString(),startDate:r,endDate:n,data:e},$.info(`个股数据${t}强制更新，代码 ${a}, 更新时间：${i.updateTime}, 更新时间范围: ${r} - ${n}, 总条数：${i.data&&i.data.length}`)}catch(e){throw $.error(`强制更新个股${a}数据${t}时出现错误：${e}`),e}}else{i=await h(t,a),$.debug(`读取本地数据${a}.${t}：${i.updateTime}, ${i.startDate}, ${i.endDate}, ${i.data&&i.data.length}`);let e="";if(i.data&&i.data.length>0){let t=i.endDate;e=p(t,"YYYYMMDD").add(1,"days").format("YYYYMMDD");let n=p();if(n.diff(e,"days")<=0&&n.hours()<15)return void $.log("没有新的数据，不需要更新 "+a)}let[n,r,o]=await m.queryStockInfo(t,a,e);i&&!i.startDate&&(i.startDate=o),n&&n.length>0?(i.updateTime=p().toISOString(),i.endDate=r,i.data.unshift(...n),$.info(`个股数据${t}更新，代码 ${a}, 更新时间：${i.updateTime}, 更新时间范围: ${o} - ${r}, 更新条数：${n&&n.length}，总条数：${i.data&&i.data.length}`)):(i=null,$.info(`个股数据${t}没有更新，代码 ${a}`))}}catch(e){throw $.error(`${a} 个股数据${t}更新时发生错误，${e}`),e}try{if(i&&i.data&&i.data.length>0){let e=JSON.stringify(i),n=u(t,a);$.debug(`保存个股${a}数据${t}到：${n}`),await S.writeFile(n,e,"utf-8")}}catch(e){throw new Error(`保存个股${a}数据${t}时出现错误，请检查后重新执行：${e}`)}}async function E(t=!1,a=!1,e=!1,i=!1,n=!1,r=!1,o=!1){$.debug(`参数：强制更新 ${t}, 更新股票信息数据 ${a}, 更新股票财务数据 ${e}, 更新主营业务构成 ${i}, 更新分红送股 ${n}, 更新股权质押数据 ${r}，更新指数数据 ${o}`);let[l,c]=await async function(t){let a=p();$.info("获取和更新股票列表数据 ...");let e=await m.stockBasic(),i={updateTime:a.toISOString(),data:e};await _(i,"stock-list.json"),$.info("股票列表数据更新完毕！"),$.info("获取和更新指数列表数据 ...");let n={updateTime:a.toISOString(),data:[]},r=await Promise.all(m.indexMarketList.map(async t=>m.indexBasic(t.code)));r&&r.length>0&&r.forEach(t=>{if(t&&t.length>0){let a=t.length,e=(t=t.filter(t=>w.isEmpty(t.exp_date))).length;$.debug(`指数过滤，总共${a}, 剩余${e}`),n.data.push(...t)}});return await _(n,"index-list.json"),$.info("更新指数列表数据完成！"),[i,n]}();a&&await async function(t,a){let e=t&&t.data;if(e&&e.length>0){let t=[];$.info("个股信息数据更新准备...");for(let i=0;i<e.length;i++)for(let n=0;n<j.length;n++)t.push({caller:D,args:[j[n],e[i].ts_code,a]});if($.info("个股信息数据更新准备完毕！"),t&&t.length>0){let a=g(t,30,"个股数据更新任务");try{$.debug("等待个股数据更新队列完成..."),await Promise.all(a),$.info(m.showInfo()),$.debug("个股数据更新队列全部执行完毕！")}catch(t){$.error("个股数据更新任务执行 错误！"+t)}}}}(l,t),e&&await async function(t,a){let e=t&&t.data;if(e&&e.length>0){let t=[];$.info("个股财务数据更新准备...");for(let i=0;i<e.length;i++)for(let n=0;n<O.length;n++)t.push({caller:D,args:[O[n],e[i].ts_code,a]});if($.info("个股财务数据更新准备完毕！"),t&&t.length>0){let a=g(t,30,"个股财务数据任务");try{$.debug("等待个股财务数据更新队列完成..."),await Promise.all(a),$.info(m.showInfo()),$.debug("个股财务数据更新队列全部执行完毕！")}catch(t){$.error("个股财务数据更新任务执行 错误！"+t)}}}}(l,t),i&&await async function(t,a){let e=t&&t.data;if(e&&e.length>0){let t=[];$.info("个股主营业务数据更新准备...");for(let i=0;i<e.length;i++)t.push({caller:D,args:[d.financialMainbiz,e[i].ts_code,a]});if($.info("个股主营业务数据更新准备完毕！"),t&&t.length>0){let a=g(t,30,"个股主营业务数据任务");try{$.debug("等待个股主营业务数据更新队列完成..."),await Promise.all(a),$.info(m.showInfo()),$.debug("个股主营业务数据更新队列全部执行完毕！")}catch(t){$.error("个股主营业务数据更新任务执行 错误！"+t)}}}}(l,t),n&&await async function(t){let a=t&&t.data;if(a&&a.length>0){let t=[];$.info("个股分红送股数据更新准备...");for(let e=0;e<a.length;e++)t.push({caller:I,args:[d.dividend,a[e].ts_code]});if($.info("个股分红送股数据更新准备完毕！"),t&&t.length>0){let a=g(t,20,"个股分红送股数据任务");try{$.debug("等待个股分红送股数据更新队列完成..."),await Promise.all(a),$.info(m.showInfo()),$.debug("个股分红送股数据更新队列全部执行完毕！")}catch(t){$.error("个股分红送股数据更新任务执行 错误！"+t)}}}}(l),r&&await async function(t){let a=t&&t.data;if(a&&a.length>0){let t=[];$.info("个股股权质押数据更新准备...");for(let e=0;e<a.length;e++)t.push({caller:I,args:[d.pledgeStat,a[e].ts_code]}),t.push({caller:I,args:[d.pledgeDetail,a[e].ts_code]});if($.info("个股股权质押数据更新准备完毕！"),t&&t.length>0){let a=g(t,20,"个股股权质押数据任务");try{$.debug("等待个股股权质押数据更新队列完成..."),await Promise.all(a),$.info(m.showInfo()),$.debug("个股股权质押数据更新队列全部执行完毕！")}catch(t){$.error("个股股权质押数据更新任务执行 错误！"+t)}}}}(l),o&&await async function(t,a){if(t&&t.data&&t.data.length>0){$.info("指数日线数据更新开始 ...");let e=t.data.map(t=>({caller:D,args:[d.indexDaily,t.ts_code,a]})),i=g(e,20,"指数日线更新任务");try{$.debug("等待指数日线更新队列完成 ..."),await Promise.all(i),$.debug("指数日线数据更新队列全部完成！")}catch(t){$.error("指数日线任务执行 错误：%o",t)}$.info(m.showInfo()),$.info("指数日线数据更新完毕！")}}(c,t)}const j=[d.daily,d.adjustFactor,d.suspendInfo,d.dailyBasic,d.moneyFlow],O=[d.income,d.balanceSheet,d.cashFlow,d.forecast,d.express,d.financialIndicator,d.disclosureDate];async function I(t,a){let e=p();if(w.isEmpty(a))throw new Error(`没有设置查询${t}的个股代码`);$.info(`个股${a}获取和更新${t}数据 ...`);let i=await m.queryStockInfo(t,a),n={updateTime:e.toISOString(),data:i};$.info(`个股${a} 数据${t}更新，更新时间：${n.updateTime}, 总条数：${n.data&&n.data.length}`);try{if(n&&n.data&&n.data.length>0){let e=JSON.stringify(n),i=u(t,a);$.debug(`保存个股${a}数据${t}到：${i}`),await S.writeFile(i,e,"utf-8")}}catch(e){throw $.error(`保存个股${a}数据${t}错误：${e}`),new Error(`保存个股${a}数据${t}时出现错误，请检查后重新执行：${e}`)}}async function _(t,a){try{let e=JSON.stringify(t),i=b.join(l(),a);await S.writeFile(i,e,{encoding:"utf-8"})}catch(t){throw new Error("保存列表数据时出现错误，请检查后重新执行："+t)}}async function q(){try{$.debug("检查根目录状态："),$.info("清理股票列表数据...");let t=b.join(l(),"stock-list.json");try{await S.access(t,x.constants.F_OK);try{await S.unlink(t)}catch(t){throw t}}catch(t){}$.info("清理股票列表数据完成"),$.info("清理指数列表数据...");let a=b.join(l(),"index-list.json");try{await S.access(a,x.constants.F_OK);try{await S.unlink(a)}catch(t){throw t}}catch(t){}$.info("清理指数列表数据完成"),$.info("清理股票历史数据...");let e=b.join(l(),o.daily);try{await S.access(e,x.constants.F_OK);try{let t=await S.readdir(e);$.info(`共有${t.length}个历史数据文件待删除`),t.forEach(async t=>{await S.unlink(b.join(e,t))})}catch(t){throw t}}catch(t){}$.info("清理股票历史数据完成"),$.info("清理股票信息数据...");let i=b.join(l(),o.info);try{await S.access(i,x.constants.F_OK);try{let t=await S.readdir(i);$.info(`共有${t.length}个历史数据文件待删除`),t.forEach(async t=>{await S.unlink(b.join(i,t))})}catch(t){throw t}}catch(t){}$.info("清理股票信息数据完成"),$.info("清理股票财务数据...");let n=b.join(l(),o.financial);try{await S.access(n,x.constants.F_OK);try{let t=await S.readdir(n);$.info(`共有${t.length}个历史数据文件待删除`),t.forEach(async t=>{await S.unlink(b.join(n,t))})}catch(t){throw t}}catch(t){}$.info("清理股票财务数据完成")}catch(t){throw new Error("清除所有已经同步数据发生错误："+t)}}export{q as clearAllData,h as readStockData,s as readStockIndexList,c as readStockList,d as stockDataNames,E as updateData,D as updateStockInfoData};
