const t=require("lodash"),a=require("os"),e=require("path"),i=require("fs"),r=i.promises,n=require("pino")({prettyPrint:{levelFirst:!0,translateTime:"SYS:standard",crlf:!0},prettifier:require("pino-pretty")});process.env.LOGGER&&(n.level=process.env.LOGGER);function o(){return e.join(a.homedir(),".wtda")}async function s(){let a=null;try{await d();let i=e.join(o(),"stock-list.json");a=JSON.parse(await r.readFile(i,"utf-8")),t.isEmpty(a)||n.debug("股票列表更新时间 @"+a.updateTime)}catch(t){throw n.error("读取股票列表数据错误："+t),new Error("读取股票列表过程中出现错误，请检查后重新运行："+t)}return t.isEmpty(a)?{updateTime:"",data:[]}:a}async function l(){let a=null;try{await d();let i=e.join(o(),"index-list.json");a=JSON.parse(await r.readFile(i,"utf-8")),t.isEmpty(a)||n.debug("指数列表更新时间 @"+a.updateTime)}catch(t){throw n.error("读取指数列表数据错误："+t),new Error("读取指数列表过程中出现错误，请检查后重新运行："+t)}return t.isEmpty(a)?{updateTime:"",data:[]}:a}async function c(a){if(t.isEmpty(a))throw new Error("未设置读取股票代码");let i={updateTime:null,data:[]};try{await d();let t=e.join(o(),"daily",a+".json");try{i=JSON.parse(await r.readFile(t,"utf-8"))}catch(t){i={data:[]}}}catch(t){n.error("从本地读取日线数据时发生错误 "+t)}return i}async function d(){let t=o();try{await r.access(t,i.constants.F_OK|i.constants.R_OK|i.constants.W_OK)}catch(a){n.debug("检查数据根目录错误 "+a),await r.mkdir(t,{recursive:!0})}let a=e.join(t,"daily");try{await r.access(a,i.constants.F_OK|i.constants.R_OK|i.constants.W_OK)}catch(t){n.debug("检查日线历史目录错误 "+t),await r.mkdir(a,{recursive:!0})}}const u=require("lodash"),f=require("moment"),h=require("@wt/lib-taskqueue"),w=require("@wt/lib-tushare"),y=require("pino")({prettyPrint:{levelFirst:!0,translateTime:"SYS:standard",crlf:!0},prettifier:require("pino-pretty")});process.env.LOGGER&&(y.level=process.env.LOGGER);const p=require("path"),g=require("fs"),m=g.promises;async function j(t=!1,a=!1,e=!1,i=!1,r=!1){let n=f();y.info("获取和更新股票列表数据 ..."),y.debug(`参数：强制更新 ${t}, 全部更新 ${r}，更新股票日线 ${a}, 更新指数日线 ${i}`);let o=await w.stockBasic(),s={updateTime:n.toISOString(),data:o};await S(s,"stock-list.json"),y.info("股票列表数据更新完毕！"),y.info("获取和更新指数列表数据 ...");let l={updateTime:n.toISOString(),data:[]},c=await Promise.all(w.indexMarketList.map(async t=>w.indexBasic(t.code)));if(c&&c.length>0&&c.forEach(t=>{if(t&&t.length>0){let a=t.length,e=(t=t.filter(t=>u.isEmpty(t.exp_date))).length;y.debug(`指数过滤，总共${a}, 剩余${e}`),l.data.push(...t)}}),await S(l,"index-list.json"),y.info("更新指数列表数据完成！"),r||a){if(y.info("开始更新股票日线数据..."),u.isArray(o)&&o.length>0){let a=o.map(a=>({caller:$,args:[a.ts_code,t,"S"]})),e=h(a,20,"股票日线更新任务");try{y.debug("等待股票日线更新队列完成..."),await Promise.all(e),y.debug("股票日线更新队列全部执行完毕！")}catch(t){y.error("股票日线任务执行 错误！"+t)}}y.info(w.showInfo()),y.info("股票日线数据更新完毕!")}if(r||e){if(y.info("开始更新股票复权因子数据..."),u.isArray(o)&&o.length>0){let a=o.map(a=>({caller:O,args:[a.ts_code,t]})),e=h(a,20,"股票复权因子更新任务");try{y.debug("等待股票日线复权因子更新队列完成..."),await Promise.all(e),y.debug("股票日线复权因子更新队列全部执行完毕！")}catch(t){y.error("股票日线复权因子任务执行 错误！"+t)}}y.info(w.showInfo()),y.info("股票复权因子数据更新完毕!")}if((r||i)&&(y.info("指数日线数据更新开始 ..."),u.isArray(l.data)&&l.data.length>0)){let a=l.data.map(a=>({caller:$,args:[a.ts_code,t,"I"]})),e=h(a,20,"指数日线更新任务");try{y.debug("等待指数日线更新队列完成 ..."),await Promise.all(e),y.debug("指数日线数据更新队列全部完成！")}catch(t){y.error("指数日线任务执行 错误：%o",t)}y.info(w.showInfo()),y.info("指数日线收护具更新完毕！")}}async function $(t,a=!1,e="S"){if(u.isEmpty(t))return{data:[]};if("S"!==e&&"I"!==e)return{data:[]};let i;try{if(a){let a;y.debug("force update "+t),a="S"===e?await w.stockDaily(t):await w.indexDaily(t),i={updateTime:f().toISOString(),data:a},y.info(`日线数据强制更新，代码 ${t}, 更新时间：${i.updateTime}, 总条数：${i.data&&i.data.length}`)}else{i=await c(t);let a,r="";if(i.data&&i.data.length>0){let a=i.data[0].trade_date;r=f(a,"YYYYMMDD").add(1,"days").format("YYYYMMDD");let e=f();if(e.diff(r,"days")<=0&&e.hours()<15)return void y.log("没有新的数据，不需要更新 "+t)}a="S"===e?await w.stockDaily(t,r):await w.indexDaily(t,r),a&&a.length>0?(i.updateTime=f().toISOString(),i.data.unshift(...a),y.info(`日线数据更新，代码 ${t}, 更新时间：${i.updateTime}, 更新条数：${a&&a.length}，总条数：${i.data&&i.data.length}`)):(i=null,y.info("日线数据没有更新，代码 "+t))}}catch(a){throw y.error(`${t} 日线数据更新时发生错误，${a}`),a}try{if(i){await d();let a=JSON.stringify(i),e=p.join(o(),"daily",t+".json");await m.writeFile(e,a,"utf-8")}}catch(a){throw new Error("保存日线历史数据时出现错误，请检查后重新执行："+t+","+a)}}async function O(a,i=!1){if(u.isEmpty(a))return{data:[]};let s;try{if(i)y.debug("force update "+a),s=await w.adjustFactor(a),y.info(`股票复权因子数据强制更新，代码 ${a}, 总条数：${s.data&&s.length}`);else{s=await async function(a){if(t.isEmpty(a))throw new Error("未设置读取股票代码");let i=[];try{await d();let t=e.join(o(),"daily",a+".adj.json");try{i=JSON.parse(await r.readFile(t,"utf-8"))}catch(a){n.debug(`读取股票复权因子文件${t} 错误：${a}`),i=[]}}catch(t){n.error("从本地读取日线复权因子数据时发生错误 "+t)}return i}(a);let i="";if(s&&s.length>0){let t=s[0].trade_date;i=f(t,"YYYYMMDD").add(1,"days").format("YYYYMMDD");let e=f();if(e.diff(i,"days")<=0&&e.hours()<15)return void y.debug("没有新的复权因子数据，不需要更新 "+a)}let l=await w.adjustFactor(a,i);y.debug(`${a} 复权因子数据返回：${s&&s.length}`),l&&l.length>0?(s.unshift(...l),y.info(`日线复权因子数据更新，代码 ${a}, 更新条数：${l&&l.length}，总条数：${s&&s.length}`)):(s=null,y.info("日线复权因子数据没有更新，代码 "+a))}}catch(t){throw y.error(`${a} 日线复权因子数据更新时发生错误，${t}`),t}try{if(s&&s.length>0){let t=JSON.stringify(s),e=p.join(o(),"daily",a+".adj.json");await m.writeFile(e,t,"utf-8")}}catch(t){throw new Error("保存复权因子数据时出现错误，请检查后重新执行："+a+","+t)}}async function S(t,a){try{await d();let e=JSON.stringify(t),i=p.join(o(),a);await m.writeFile(i,e,{encoding:"utf-8"})}catch(t){throw new Error("保存列表数据时出现错误，请检查后重新执行："+t)}}async function E(){try{y.debug("检查根目录状态："),await d(),y.info("清理股票列表数据...");let t=p.join(o(),"stock-list.json");try{await m.access(t,g.constants.F_OK);try{await m.unlink(t)}catch(t){throw t}}catch(t){}y.info("清理股票列表数据完成"),y.info("清理指数列表数据...");let a=p.join(o(),"index-list.json");try{await m.access(a,g.constants.F_OK);try{await m.unlink(a)}catch(t){throw t}}catch(t){}y.info("清理指数列表数据完成"),y.info("清理股票历史数据...");let e=p.join(o(),"daily");try{await m.access(e,g.constants.F_OK);try{let t=await m.readdir(e);y.info(`共有${t.length}个历史数据文件待删除`),t.forEach(async t=>{await m.unlink(p.join(e,t))})}catch(t){throw t}}catch(t){}y.info("清理股票历史数据完成")}catch(t){throw new Error("清除所有已经同步数据发生错误："+t)}}export{E as clearAllData,c as readStockDaily,l as readStockIndexList,s as readStockList,O as updateAdjustFactorData,$ as updateDailyData,j as updateData};
